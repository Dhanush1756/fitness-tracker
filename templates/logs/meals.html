{% extends "base.html" %}

{% block title %}Log Meal{% endblock %}

{% block content %}
<div class="form-container card">
    <h1 style="margin-bottom: 2rem;">Log a Meal</h1>
    
    <form id="meal-log-form" method="POST">
        <div class="form-group">
            <label for="name">What did you eat?</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="name" name="name" required placeholder="e.g., 2 eggs and a banana">
                <button type="button" id="get-nutrition-btn" class="btn btn-secondary">Get Info</button>
            </div>
            <small id="ai-status" style="margin-top: 0.5rem; display: block;"></small>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="calories">Calories (kcal)</label>
                <input type="number" id="calories" name="calories" required>
            </div>
            <div class="form-group">
                <label for="protein">Protein (g)</label>
                <input type="number" id="protein" name="protein" step="0.1">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="carbs">Carbs (g)</label>
                <input type="number" id="carbs" name="carbs" step="0.1">
            </div>
            <div class="form-group">
                <label for="fat">Fat (g)</label>
                <input type="number" id="fat" name="fat" step="0.1">
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%;">Log This Meal</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const getInfoBtn = document.getElementById('get-nutrition-btn');
    const foodNameInput = document.getElementById('name');
    const statusText = document.getElementById('ai-status');

    getInfoBtn.addEventListener('click', async function() {
        const foodName = foodNameInput.value;
        if (!foodName) {
            statusText.textContent = "Please enter a food description first.";
            statusText.style.color = 'var(--danger-color)';
            return;
        }

        statusText.textContent = "Asking the AI chef... üßë‚Äçüç≥";
        statusText.style.color = 'var(--text-light-color)';
        getInfoBtn.disabled = true;

        try {
            const response = await fetch('/api/get-food-details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ food_name: foodName })
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById('calories').value = result.data.calories || 0;
                document.getElementById('protein').value = result.data.protein || 0;
                document.getElementById('carbs').value = result.data.carbs || 0;
                document.getElementById('fat').value = result.data.fat || 0;
                statusText.textContent = "Nutrition info filled automatically!";
                statusText.style.color = 'var(--success-color)';
            } else {
                statusText.textContent = `Error: ${result.error}`;
                statusText.style.color = 'var(--danger-color)';
            }

        } catch (error) {
            statusText.textContent = "A network error occurred. Please try again.";
            statusText.style.color = 'var(--danger-color)';
        } finally {
            getInfoBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}